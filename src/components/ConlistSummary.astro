---
import { type Event } from '../event';

interface Props {
	events: Event[];
	dateCutoff: Date;
}

const { events, dateCutoff } = Astro.props;

const seriesEvents: Record<string, Event[]> = {};
events.forEach((e) => {
	if (!(e.series in seriesEvents)) {
		seriesEvents[e.series] = [];
	}
	seriesEvents[e.series]!.push(e);
});

const sortedSeries = Object.keys(seriesEvents);
sortedSeries.sort();
Object.values(seriesEvents).forEach((e) => {
	e.sort((a, b) => {
		// Sort undefined start dates after defined start dates
		if (!a.startDate && !b.startDate) {
			return 0;
		} else if (!a.startDate) {
			return 1;
		} else if (!b.startDate) {
			return -1;
		} else {
			return a.startDate > b.startDate ? 1 : -1;
		}
	});
});
---

<ul>
	{
		sortedSeries.map((s) => (
			<li>
				{`${s}: `}
				{seriesEvents[s]!.map((e) => {
					if (
						!e.startDate ||
						e.startDate >= dateCutoff ||
						e.status === 'Tentative'
					) {
						return <i>{e.specifier}</i>;
					} else if (e.status === 'Not Attending') {
						return <s>{e.specifier}</s>;
					} else {
						return <span>{e.specifier}</span>;
					}
				}).reduce((a, v) => (!a ? [v] : [...a, ', ', v]), null)}
			</li>
		))
	}
</ul>
